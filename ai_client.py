# ai_client.py
import os
import json
import asyncio
from typing import Literal, Optional

from dotenv import load_dotenv
from openai import OpenAI

from datetime import datetime, timezone, timedelta

# –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –º–æ–∂–Ω–æ –±—ã–ª–æ –¥–æ—Å—Ç–∞—Ç—å
load_dotenv()

OPENROUTER_API_KEY = os.getenv("OPENROUTER_API_KEY")
if not OPENROUTER_API_KEY:
    raise RuntimeError("OPENROUTER_API_KEY is not set in environment")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ OpenRouter (OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π) [web:45][web:49][web:83]
client = OpenAI(
    base_url="https://openrouter.ai/api/v1",
    api_key=OPENROUTER_API_KEY,
)

async def ask_llm(description: str, system_msg:str) -> dict:
    user_msg = description

    error = ""
    max_retries=3
    for i in range(max_retries):
        try:
            print("–ø–µ—Ä–µ–¥ –ø–æ–ª—É—á–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç–∞")
            # –í—ã–∑–æ–≤ chat completion —á–µ—Ä–µ–∑ OpenRouter [web:45][web:49][web:76]
            response = client.chat.completions.create(
                model="google/gemini-2.0-flash-lite-001",
                messages=[
                    {"role": "system", "content": system_msg},
                    {"role": "user", "content": user_msg},
                ],
                # JSON-—Ä–µ–∂–∏–º: –ø—Ä–æ—Å–∏–º –º–æ–¥–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å JSON-–æ–±—ä–µ–∫—Ç [web:81][web:85]
                response_format={"type": "json_object"},
                max_tokens=200,
                temperature=0.1,
            )
            print("–ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞")

            content: str = response.choices[0].message.content
            data = json.loads(content)

            print(data)

            return data  

        except Exception as e:
            print("–ø–æ–ø–∞–ª –≤ exception")
            # –ù–∞ –ø—Ä–æ–¥–µ –ª—É—á—à–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É
            error=e
            await asyncio.sleep(0.5)

    return error

async def classify_task(description: str) -> dict: 
    print("–ø–æ–ø–∞–ª –≤ classify_task")
    system_msg = """
    –¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ —Ç–∞–π–º-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç—É. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–Ω—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –æ–Ω–æ –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á.

    –û–ë–©–ò–ï –ü–†–ê–í–ò–õ–ê:
    1. –¢—ã –í–°–ï–ì–î–ê –æ—Ç–≤–µ—á–∞–µ—à—å –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.
    2. –ù–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON.
    3. –ö–æ—Ä–Ω–µ–≤–æ–π –æ–±—ä–µ–∫—Ç –í–°–ï–ì–î–ê —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ "type".

    –í–û–ó–ú–û–ñ–ù–´–ï –¢–ò–ü–´ –û–¢–í–ï–¢–ê:

    1) "type": "tasks" ‚Äî –µ—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å –æ–¥–Ω–∞ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á.
    2) "type": "chat" ‚Äî –µ—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –ù–ï–¢ –∑–∞–¥–∞—á (—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è, —ç–º–æ—Ü–∏–∏, –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –≤–æ–ø—Ä–æ—Å—ã –Ω–µ –ø—Ä–æ –∑–∞–¥–∞—á–∏).

    --------------------------------------------------

    –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê, –ï–°–õ–ò –ù–ê–ô–î–ï–ù–´ –ó–ê–î–ê–ß–ò:

    {
    "type": "tasks",
    "items": [
        {
        "category": "—Ç–∏–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",
        "date": "–¥–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞",
        "time": "–≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞",
        "remind_date": "–¥–∞—Ç–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞",
        "remind_time": "–≤—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞",
        "task": "–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"
        }
    ]
    }

    –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –æ–ø–∏—Å–∞–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á ‚Äî –¥–æ–±–∞–≤—å –∫–∞–∂–¥—É—é –æ—Ç–¥–µ–ª—å–Ω—ã–º –æ–±—ä–µ–∫—Ç–æ–º –≤ –º–∞—Å—Å–∏–≤ items.

    --------------------------------------------------

    –ö–ê–¢–ï–ì–û–†–ò–ò –ó–ê–î–ê–ß (–∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∏—Ö):

    - short_5 ‚Äî –¥–æ 5 –º–∏–Ω—É—Ç.
    - short_30 ‚Äî –æ—Ç 5 –¥–æ 30 –º–∏–Ω—É—Ç.
    - short_120 ‚Äî –æ—Ç 30 –º–∏–Ω—É—Ç –¥–æ 2 —á–∞—Å–æ–≤.
    - long ‚Äî –±–æ–ª–µ–µ 2 —á–∞—Å–æ–≤ –∏–ª–∏ —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã.

    –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: "short_5", "short_30", "short_120", "long".

    --------------------------------------------------

    –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê, –ï–°–õ–ò –ó–ê–î–ê–ß –ù–ï–¢:

    {
    "type": "chat",
    "message": "–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"
    }

    –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ:
    - –æ–±—ä—è—Å–Ω—è—Ç—å, —á—Ç–æ –∑–∞–¥–∞—á–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã
    - –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –ø–æ–º–æ—â—å —Å –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∑–∞–¥–∞—á
    - –±—ã—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º
    - —é–º–æ—Ä –¥–æ–ø—É—Å—Ç–∏–º, –Ω–æ —É–º–µ—Ä–µ–Ω–Ω–æ

    --------------------------------------------------

    –ü–†–ò–ú–ï–†–´:

    –ü–†–ò–ú–ï–† 1:
    –≤–≤–æ–¥:
    —Å–µ–≥–æ–¥–Ω—è 2026-01-31 10:20, –º–Ω–µ –Ω—É–∂–Ω–æ –∑–∞–≤—Ç—Ä–∞ –∫—É–ø–∏—Ç—å –ø–æ—Å–ª–µ –æ–±–µ–¥–∞ –Ω–∞—É—à–Ω–∏–∫–∏ –¥–ª—è –ù–∞—Ç–∞—à–∏

    –æ—Ç–≤–µ—Ç:
    {
    "type": "tasks",
    "items": [
        {
        "category": "short_5",
        "date": "2026-02-01",
        "time": "",
        "remind_date": "",
        "remind_time": "",
        "task": "–∫—É–ø–∏—Ç—å –Ω–∞—É—à–Ω–∏–∫–∏ –ù–∞—Ç–∞—à–µ"
        }
    ]
    }

    --------------------------------------------------

    –ü–†–ò–ú–ï–† 2:
    –≤–≤–æ–¥:
    —Å–µ–≥–æ–¥–Ω—è 2026-07-19 20:07, –Ω—É–∂–Ω–æ —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é —Å—Ö–æ–¥–∏—Ç—å –≤ –∑–∞–ª –≤ 19, –Ω–∞–ø–æ–º–Ω–∏ –∑–∞ –¥–µ–Ω—å –≤–µ—á–µ—Ä–æ–º. –∏ –Ω—É–∂–Ω–æ —Å–µ–≥–æ–¥–Ω—è –∑–∞–±—Ä–∞—Ç—å –ø—Ä–æ—Ç–µ–∏–Ω —Å –æ–∑–æ–Ω–∞

    –æ—Ç–≤–µ—Ç:
    {
    "type": "tasks",
    "items": [
        {
        "category": "short_120",
        "date": "2026-07-26",
        "time": "19:00",
        "remind_date": "2026-07-25",
        "remind_time": "18:00",
        "task": "—Å—Ö–æ–¥–∏—Ç—å –≤ –∑–∞–ª"
        },
        {
        "category": "short_30",
        "date": "2026-07-19",
        "time": "",
        "remind_date": "",
        "remind_time": "",
        "task": "–∑–∞–±—Ä–∞—Ç—å –ø—Ä–æ—Ç–µ–∏–Ω —Å –æ–∑–æ–Ω–∞"
        }
    ]
    }
    –ü–†–ò–ú–ï–† 3:
    –≤–≤–æ–¥:
    —Å–µ–≥–æ–¥–Ω—è 2025-09-10 10:17, –Ω–∞–ø–æ–º–Ω–∏ –º–Ω–µ —á–µ—Ä–µ–∑ 40 –º–∏–Ω—É—Ç —Å–Ω—è—Ç—å –∫–∞—Å—Ç—Ä—é–ª—é —Å –ø–ª–∏—Ç—ã
    {
    "type": "tasks",
    "items": [
        {
        "category": "short_5",
        "date": "2025-09-10",
        "time": "10:57",
        "remind_date": "2025-09-10",
        "remind_time": "10:57",
        "task": "—Å–Ω—è—Ç—å –∫–∞—Å—Ç—Ä—é–ª—é —Å –ø–ª–∏—Ç—ã"
        }
    ]
    }
    --------------------------------------------------

    –ü–†–ò–ú–ï–† 4 (–ù–ï–¢ –ó–ê–î–ê–ß):
    –≤–≤–æ–¥:
    —Å–µ–≥–æ–¥–Ω—è 2024-11-06 13:14, —è —Å–µ–≥–æ–¥–Ω—è –¥—É–º–∞–ª –æ —Ä–∏–º—Å–∫–æ–π –∏–º–ø–µ—Ä–∏–∏

    –æ—Ç–≤–µ—Ç:
    {
    "type": "chat",
    "message": "–ó–≤—É—á–∏—Ç —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏ üôÇ –ù–æ –∑–∞–¥–∞—á —è —Ç—É—Ç –Ω–µ –≤–∏–∂—É. –ù–∞–ø–∏—à–∏, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å ‚Äî —è –ø–æ–º–æ–≥—É –≤—Å—ë —Ä–∞–∑–ª–æ–∂–∏—Ç—å."
    }

    --------------------------------------------------

    –ü–†–ò–ú–ï–† 4 (–ë–ï–°–°–ú–´–°–õ–ï–ù–ù–´–ô –¢–ï–ö–°–¢):
    –≤–≤–æ–¥:
    —Å–µ–≥–æ–¥–Ω—è 2026-01-01 14:14, –ø—Ä–æ—ã–∏–∏–æ

    –æ—Ç–≤–µ—Ç:
    {
    "type": "chat",
    "message": "–ö–∞–∂–µ—Ç—Å—è, —Ç—É—Ç –∑–∞–∫—Ä–∞–ª–∞—Å—å –æ–ø–µ—á–∞—Ç–∫–∞ üôÇ –ù–∞–ø–∏—à–∏ –∑–∞–¥–∞—á—É, –∏ —è –ø–æ–º–æ–≥—É –µ—ë —Å–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å."
    }

    --------------------------------------------------

    –í–ê–ñ–ù–û:
    - –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–π –º–∞—Å—Å–∏–≤ –∏–ª–∏ —Å—Ç—Ä–æ–∫—É –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ.
    - –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–º–µ—à–∏–≤–∞–π –∑–∞–¥–∞—á–∏ –∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã.
    - –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ–º–Ω–µ–Ω–∏–µ ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –∑–∞–¥–∞—á –ù–ï–¢ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º type = "chat".

    """
    data = await ask_llm(description, system_msg)
    return data
    

async def edit_task(information: dict) -> dict:
    """
    –ø–æ–ª—É—á–∞–µ—Ç:
    {
    "request":"–∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
    "category": "—Ç–∏–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",
    "date": "–¥–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞",
    "time": "–≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞",
    "remind_date": "–¥–∞—Ç–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞",
    "remind_time": "–≤—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞",
    "task": "–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"
    }
 
    """
    system_msg = f"""
    –¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ —Ç–∞–π–º-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç—É. –í–æ—Ç –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:
    
    {{
    "type": "tasks",
    "items": [
        {{
        "category": {information["category"]},
        "date": {information["date"]}",
        "time": {information["time"]},
        "remind_date": {information["remind_date"]},
        "remind_time": {information["remind_time"]},
        "task": {information["task"]}
        }}
    ]
    }}
    –ê –≤–æ—Ç –ø—Ä–æ—Å—å–±–∞ —Ç–≤–æ–µ–≥–æ –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞ (–µ–º—É –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É): {information["request"]}
    –ü—Ä–∏—à–ª–∏ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –∑–∞–¥–∞—á–∏ –≤ —Ç–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:
    {
    "type": "tasks",
    "items": [
        {
        "category": "—Ç–∏–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",
        "date": "–¥–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞",
        "time": "–≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞",
        "remind_date": "–¥–∞—Ç–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞",
        "remind_time": "–≤—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞",
        "task": "–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"
        }
    ]
    }
    –û–ß–ï–ù–¨ –í–ê–ñ–ù–û –ü–†–ò–°–õ–ê–¢–¨ –ò–ú–ï–ù–ù–û –í –¢–ê–ö–û–ú –§–û–†–ú–ê–¢–ï
    """
    description = "–ø—Ä–∏—à–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ"
    data = await ask_llm(description, system_msg)
    return data